{"version":3,"sources":["wwwroot/scripts/hx-signalr.js"],"sourcesContent":["/*\nSignalR Extension\n============================\nThis extension adds support for SignalR to htmx.\nBased on WebSockets extension (https://github.com/bigskysoftware/htmx/blob/master/src/ext/ws.js)\nand SSE extension (https://github.com/bigskysoftware/htmx/blob/master/src/ext/sse.js)\nby bigskysoftware.\n*/\n\n(function () {\n\n    /** @type {import(\"../htmx\").HtmxInternalApi} */\n    var api;\n\n    var signalRConnect = \"signalr-connect\";\n    var signalRSubscribe = \"signalr-subscribe\";\n    var signalRSend = \"signalr-send\";\n\n    htmx.defineExtension(\"signalr\", {\n\n        /**\n         * init is called once, when this extension is first registered.\n         * @param {import(\"../htmx\").HtmxInternalApi} apiRef\n         */\n        init: function (apiRef) {\n\n            // Store reference to internal API\n            api = apiRef;\n\n            // Default function for creating new EventSource objects\n            if (htmx.createHubConnection == undefined) {\n                htmx.createHubConnection = createHubConnection;\n            }\n        },\n\n        /**\n         * onEvent handles all events passed to this extension.\n         *\n         * @param {string} name\n         * @param {Event} evt\n         */\n        onEvent: function (name, evt) {\n\n            var parent = evt.target ?? evt.detail.elt;\n\n            switch (name) {\n\n                // Try to remove hub connection when elements are removed\n                case \"htmx:beforeCleanupElement\":\n\n                    var internalData = api.getInternalData(parent)\n\n                    if (internalData.HubConnection != undefined) {\n                        internalData.HubConnection.stop();\n                    }\n                    return;\n\n                // Try to create hub connections when elements are processed\n                case \"htmx:beforeProcessNode\":\n\n                    forEach(queryAttributeOnThisOrChildren(parent, signalRConnect), function (child) {\n                        ensureHubConnection(child)\n                    });\n                    forEach(queryAttributeOnThisOrChildren(parent, signalRSubscribe), function (child) {\n                        ensureSubscription(child)\n                    });\n                    forEach(queryAttributeOnThisOrChildren(parent, signalRSend), function (child) {\n                        ensureSending(child)\n                    });\n            }\n        }\n    });\n\n    /**\n     * ensureHubConnection creates a new SignalR Hub Connection on the designated element, using\n     * the element's \"signalr-connect\" attribute.\n     * @param {HTMLElement} hubElt\n     * @returns\n     */\n    function ensureHubConnection(hubElt) {\n\n        // If the element containing the connection no longer exists, then\n        // do not connect/reconnect the Hub.\n        if (!api.bodyContains(hubElt)) {\n            return;\n        }\n        if (!signalR) {\n            logError('SignalR object not found. Make sure to include SignalR script in the page scripts before this extension.');\n            return;\n        }\n\n        // Get the source straight from the element's value\n        var signalrHubUrl = api.getAttributeValue(hubElt, signalRConnect)\n\n        // Create a new HubConnection and event handlers\n        /** @type {HubConnection} */\n        var hubConnection = htmx.createHubConnection(signalrHubUrl);\n        api.triggerEvent(hubElt, 'htmx:signalr:starting');\n\n        hubConnection.onreconnecting(function (error) {\n            api.triggerEvent(hubElt, 'htmx:signalr:reconnecting', { error: error });\n        });\n        hubConnection.onreconnected(function (connectionId) {\n            api.triggerEvent(hubElt, 'htmx:signalr:reconnected', { connectionId: connectionId });\n        });\n        hubConnection.onclose(function (error) {\n            api.triggerEvent(hubElt, 'htmx:signalr:close', { error: error });\n        });\n\n        hubConnection.start().then(function () {\n            api.triggerEvent(hubElt, 'htmx:signalr:start', { connectionId: hubConnection.connectionId })\n        }).catch(function (ex) {\n            api.triggerErrorEvent(hubElt, 'htmx:signalr:start-error', { message: ex.message, errorType: ex.errorType })\n        });\n\n        // Put the HubConnection into the HTML Element's custom data.\n        api.getInternalData(hubElt).HubConnection = hubConnection;\n    }\n\n    /**\n     * ensureSending attaches event listeners to elements with \"signalr-send\" attribute.\n     * @param {HTMLElement} elt\n     * @returns\n     */\n    function ensureSending(elt) {\n\n        // If the element containing the connection no longer exists, then\n        // do not connect/reconnect the Hub.\n        if (!api.bodyContains(elt)) {\n            return;\n        }\n        if (!signalR) {\n            logError('SignalR object not found. Make sure to include SignalR script in the page scripts before this extension.');\n            return;\n        }\n\n        var hubElement = findParentWithHubConnection(elt);\n\n        if (!hubElement) {\n            return;\n        }\n\n        processHubConnectionSend(hubElement, elt);\n    }\n\n    /**\n     * ensureMethodHandler creates a listener that handles invocations of a method defined on the element\n     * by \"signalr-method\" attribute.\n     * @param {HTMLElement} elt\n     * @returns\n     */\n    function ensureSubscription(elt) {\n\n        // If the element containing the connection no longer exists, then\n        // do not subscribe\n        if (!api.bodyContains(elt)) {\n            return;\n        }\n        if (!signalR) {\n            logError('SignalR object not found. Make sure to include SignalR script in the page scripts before this extension.');\n            return;\n        }\n\n        var hubElement = findParentWithHubConnection(elt);\n\n        if (!hubElement) {\n            return;\n        }\n\n        var hubConnection = api.getInternalData(hubElement).HubConnection;\n\n        var signalrSubscribeAttribute = api.getAttributeValue(elt, signalRSubscribe);\n        var signalrMethodNames = signalrSubscribeAttribute.split(\",\");\n\n        for (let i = 0; i < signalrMethodNames.length; i++) {\n            var method = signalrMethodNames[i].trim();\n\n            hubConnection.on(method, function handler(message) {\n                if (maybeCloseHubConnectionSource(hubElement)) {\n                    hubConnection.off(method, handler)\n                    return;\n                }\n\n                if (maybeUnsubscribe(hubElement, method, elt, handler)) {\n                    return;\n                }\n\n                var target = api.getTarget(elt);\n\n                var messageSpec = {\n                    message: message,\n                    method: method,\n                    target: target,\n                };\n                if (!api.triggerEvent(elt, 'htmx:signalr:message', messageSpec)) {\n                    return;\n                }\n\n                // Other parts of htmx expect to have response object as a string\n                // So, we serialize it\n                if (typeof (messageSpec.message) === \"object\") {\n                    messageSpec.message = JSON.stringify(messageSpec.message);\n                }\n\n                api.withExtensions(elt, function (extension) {\n                    messageSpec.message = extension.transformResponse(messageSpec.message, null, elt);\n                });\n\n                if (messageSpec.message === null || messageSpec.message === undefined) {\n                    return;\n                }\n\n                var swapSpec = api.getSwapSpecification(elt);\n                api.swap(messageSpec.target, messageSpec.message, swapSpec);\n            });\n        }\n    }\n\n    /**\n     * processHubConnectionSend adds event listeners to the <form> element so that\n     * messages can be sent to the HubConnection server when the form is submitted.\n     * @param {HTMLElement} hubElt\n     * @param {HTMLElement} sendElt\n     */\n    function processHubConnectionSend(hubElt, sendElt) {\n        var nodeData = api.getInternalData(sendElt);\n        var triggerSpecs = api.getTriggerSpecs(sendElt);\n        triggerSpecs.forEach(function (ts) {\n            api.addTriggerHandler(sendElt, ts, nodeData, function (elt, evt) {\n                var HubConnection = api.getInternalData(hubElt).HubConnection;\n                var method = api.getAttributeValue(sendElt, signalRSend);\n                var headers = api.getHeaders(sendElt, hubElt);\n                var results = api.getInputValues(sendElt, 'post');\n                var errors = results.errors;\n                var rawParameters = Object.assign({}, results.values);\n                var expressionVars = api.getExpressionVars(sendElt);\n                var allParameters = api.mergeObjects(rawParameters, expressionVars);\n                var filteredParameters = api.filterValues(allParameters, sendElt);\n                filteredParameters['HEADERS'] = headers;\n                if (errors && errors.length > 0) {\n                    api.triggerEvent(sendElt, 'htmx:validation:halted', errors);\n                    return;\n                }\n\n                if (!api.triggerEvent(sendElt, 'htmx:signalr:beforeSend', { method: method, headers: headers, allParameters: allParameters, filteredParameters: filteredParameters })) {\n                    return;\n                };\n\n                HubConnection.send(method, filteredParameters);\n                if (api.shouldCancel(evt, sendElt)) {\n                    evt.preventDefault();\n                }\n\n                api.triggerEvent(sendElt, 'htmx:signalr:afterSend', { method: method, message: filteredParameters });\n\n            });\n        })\n    }\n\n    /**\n     * maybeCloseHubConnectionSource checks to the if the element that created the HubConnection\n     * still exists in the DOM.  If NOT, then the HubConnection is closed and this function\n     * returns TRUE.  If the element DOES EXIST, then no action is taken, and this function\n     * returns FALSE.\n     *\n     * @param {*} elt\n     * @returns\n     */\n    function maybeCloseHubConnectionSource(elt) {\n        if (!api.bodyContains(elt)) {\n            api.getInternalData(elt).HubConnection.stop();\n            return true;\n        }\n        return false;\n    }\n\n    /**\n     * maybeUnsubscribe checks if the element that created the subscription to method\n     * still has matching subscription attribute. If NOT, then the subscription is removed and this function\n     * returns TRUE.  If the element DOES EXIST, then no action is taken, and this function\n     * returns FALSE.\n     *\n     * @param {*} elt\n     * @returns\n     */\n    function maybeUnsubscribe(hubElement, subscription, elt, handler) {\n        if (!api.bodyContains(elt)) {\n            api.getInternalData(hubElement).HubConnection.off(subscription, handler);\n            return true;\n        }\n        if (api.getAttributeValue(elt, signalRSubscribe).split(\",\").indexOf(subscription) == -1) {\n            api.getInternalData(hubElement).HubConnection.off(subscription, handler);\n            return true;\n        }\n        return false;\n    }\n\n    /**\n     * createHubConnection is the default method for creating new HubConnection objects.\n     * it is hoisted into htmx.createHubConnection to be overridden by the user, if needed.\n     *\n     * @param {string} url\n     * @returns HubConnection\n     */\n    function createHubConnection(url) {\n        return new signalR.HubConnectionBuilder()\n            .withUrl(url)\n            .withAutomaticReconnect()\n            .build()\n    }\n\n    /**\n     * queryAttributeOnThisOrChildren returns all nodes that contain the requested attributeName, INCLUDING THE PROVIDED ROOT ELEMENT.\n     *\n     * @param {HTMLElement} elt\n     * @param {string} attributeName\n     */\n    function queryAttributeOnThisOrChildren(elt, attributeName) {\n\n        var result = []\n\n        // If the parent element also contains the requested attribute, then add it to the results too.\n        if (api.hasAttribute(elt, attributeName)) {\n            result.push(elt);\n        }\n\n        // Search all child nodes that match the requested attribute\n        elt.querySelectorAll(\"[\" + attributeName + \"], [data-\" + attributeName + \"]\").forEach(function (node) {\n            result.push(node)\n        })\n\n        return result\n    }\n\n    /**\n     * findParentWithHubConnection returns all nodes that contain the requested attributeName, INCLUDING THE PROVIDED ROOT ELEMENT.\n     *\n     * @param {HTMLElement} elt\n     */\n    function findParentWithHubConnection(elt) {\n        var match = api.getClosestMatch(elt, hasHubConnection);\n        return match;\n    }\n\n    function hasHubConnection(node) {\n        var internalData = api.getInternalData(node);\n        return internalData.HubConnection != null;\n    }\n\n    /**\n     * @template T\n     * @param {T[]} arr\n     * @param {(T) => void} func\n     */\n    function forEach(arr, func) {\n        if (arr) {\n            for (var i = 0; i < arr.length; i++) {\n                func(arr[i]);\n            }\n        }\n    }\n})();"],"names":["api","signalRConnect","signalRSubscribe","signalRSend","createHubConnection","url","signalR","HubConnectionBuilder","withUrl","withAutomaticReconnect","build","queryAttributeOnThisOrChildren","elt","attributeName","result","hasAttribute","push","querySelectorAll","forEach","node","findParentWithHubConnection","getClosestMatch","hasHubConnection","internalData","getInternalData","HubConnection","arr","func","i","length","htmx","defineExtension","init","apiRef","undefined","onEvent","name","evt","parent","target","detail","stop","child","ensureHubConnection","hubElt","bodyContains","logError","signalrHubUrl","getAttributeValue","hubConnection","triggerEvent","onreconnecting","error","onreconnected","connectionId","onclose","start","then","catch","ex","triggerErrorEvent","message","errorType","ensureSubscription","hubElement","signalrMethodNames","signalrSubscribeAttribute","split","method","trim","on","handler","off","subscription","indexOf","messageSpec","getTarget","JSON","stringify","withExtensions","extension","transformResponse","swapSpec","getSwapSpecification","swap","ensureSending","sendElt","nodeData","triggerSpecs","getTriggerSpecs","ts","addTriggerHandler","headers","getHeaders","results","getInputValues","errors","rawParameters","Object","assign","values","expressionVars","getExpressionVars","allParameters","mergeObjects","filteredParameters","filterValues","send","shouldCancel","preventDefault"],"mappings":"CASA,AAAC,WAKG,IAFIA,EAEAC,EAAiB,kBACjBC,EAAmB,oBACnBC,EAAc,eAgSlB,SAASC,EAAoBC,CAAG,EAC5B,OAAO,IAAIC,QAAQC,oBAAoB,GAClCC,OAAO,CAACH,GACRI,sBAAsB,GACtBC,KAAK,EACd,CAQA,SAASC,EAA+BC,CAAG,CAAEC,CAAa,EAEtD,IAAIC,EAAS,EAAE,CAYf,OATId,EAAIe,YAAY,CAACH,EAAKC,IACtBC,EAAOE,IAAI,CAACJ,GAIhBA,EAAIK,gBAAgB,CAAC,IAAMJ,EAAgB,YAAcA,EAAgB,KAAKK,OAAO,CAAC,SAAUC,CAAI,EAChGL,EAAOE,IAAI,CAACG,EAChB,GAEOL,CACX,CAOA,SAASM,EAA4BR,CAAG,EAEpC,OADYZ,EAAIqB,eAAe,CAACT,EAAKU,EAEzC,CAEA,SAASA,EAAiBH,CAAI,EAE1B,OAAOI,AAA8B,MAA9BA,AADYvB,EAAIwB,eAAe,CAACL,GACnBM,aAAa,AACrC,CAOA,SAASP,EAAQQ,CAAG,CAAEC,CAAI,EACtB,GAAID,EACA,IAAK,IAAIE,EAAI,EAAGA,EAAIF,EAAIG,MAAM,CAAED,IAC5BD,EAAKD,CAAG,CAACE,EAAE,CAGvB,CAtVAE,KAAKC,eAAe,CAAC,UAAW,CAM5BC,KAAM,SAAUC,CAAM,EAGlBjC,EAAMiC,EAGFH,AAA4BI,KAAAA,GAA5BJ,KAAK1B,mBAAmB,EACxB0B,CAAAA,KAAK1B,mBAAmB,CAAGA,CAAkB,CAErD,EAQA+B,QAAS,SAAUC,CAAI,CAAEC,CAAG,EAExB,IAAIC,EAASD,EAAIE,MAAM,EAAIF,EAAIG,MAAM,CAAC5B,GAAG,CAEzC,OAAQwB,GAGJ,IAAK,4BAED,IAAIb,EAAevB,EAAIwB,eAAe,CAACc,EAEnCf,AAA8BW,MAAAA,GAA9BX,EAAaE,aAAa,EAC1BF,EAAaE,aAAa,CAACgB,IAAI,GAEnC,MAGJ,KAAK,yBAEDvB,EAAQP,EAA+B2B,EAAQrC,GAAiB,SAAUyC,CAAK,GAC3EC,AAkBpB,SAA6BC,CAAM,EAI/B,GAAK5C,EAAI6C,YAAY,CAACD,IAGtB,GAAI,CAACtC,QAAS,OACVwC,SAAS,4GAKb,IAAIC,EAAgB/C,EAAIgD,iBAAiB,CAACJ,EAAQ3C,GAI9CgD,EAAgBnB,KAAK1B,mBAAmB,CAAC2C,GAC7C/C,EAAIkD,YAAY,CAACN,EAAQ,yBAEzBK,EAAcE,cAAc,CAAC,SAAUC,CAAK,EACxCpD,EAAIkD,YAAY,CAACN,EAAQ,4BAA6B,CAAEQ,MAAOA,CAAM,EACzE,GACAH,EAAcI,aAAa,CAAC,SAAUC,CAAY,EAC9CtD,EAAIkD,YAAY,CAACN,EAAQ,2BAA4B,CAAEU,aAAcA,CAAa,EACtF,GACAL,EAAcM,OAAO,CAAC,SAAUH,CAAK,EACjCpD,EAAIkD,YAAY,CAACN,EAAQ,qBAAsB,CAAEQ,MAAOA,CAAM,EAClE,GAEAH,EAAcO,KAAK,GAAGC,IAAI,CAAC,WACvBzD,EAAIkD,YAAY,CAACN,EAAQ,qBAAsB,CAAEU,aAAcL,EAAcK,YAAY,AAAC,EAC9F,GAAGI,KAAK,CAAC,SAAUC,CAAE,EACjB3D,EAAI4D,iBAAiB,CAAChB,EAAQ,2BAA4B,CAAEiB,QAASF,EAAGE,OAAO,CAAEC,UAAWH,EAAGG,SAAS,AAAC,EAC7G,GAGA9D,EAAIwB,eAAe,CAACoB,GAAQnB,aAAa,CAAGwB,EAChD,EAxDwCP,EACxB,GACAxB,EAAQP,EAA+B2B,EAAQpC,GAAmB,SAAUwC,CAAK,GAC7EqB,AAuFpB,SAA4BnD,CAAG,EAI3B,GAAKZ,EAAI6C,YAAY,CAACjC,IAGtB,GAAI,CAACN,QAAS,OACVwC,SAAS,4GAIb,IAAIkB,EAAa5C,EAA4BR,GAE7C,GAAKoD,GAIL,IAAIf,EAAgBjD,EAAIwB,eAAe,CAACwC,GAAYvC,aAAa,CAG7DwC,EAAqBC,AADOlE,EAAIgD,iBAAiB,CAACpC,EAAKV,GACRiE,KAAK,CAAC,KAEzD,IAAK,IAAIvC,EAAI,EAAGA,EAAIqC,EAAmBpC,MAAM,CAAED,IAAK,CAChD,IAAIwC,EAASH,CAAkB,CAACrC,EAAE,CAACyC,IAAI,GAEvCpB,EAAcqB,EAAE,CAACF,EAAQ,SAASG,EAAQV,CAAO,EAC7C,GA0F2BjD,EA1FOoD,EA2F1C,CAAKhE,EAAI6C,YAAY,CAACjC,KAClBZ,EAAIwB,eAAe,CAACZ,GAAKa,aAAa,CAACgB,IAAI,GACpC,GA7F4C,YAC3CQ,EAAcuB,GAAG,CAACJ,EAAQG,GAI9B,GAsGcP,EAtGOA,EAsGKS,EAtGOL,EAsGOxD,EAtGCA,EAsGI2D,EAtGCA,EAuGtD,AAAKvE,EAAI6C,YAAY,CAACjC,IAIlBZ,AAAiF,IAAjFA,EAAIgD,iBAAiB,CAACpC,EAAKV,GAAkBiE,KAAK,CAAC,KAAKO,OAAO,CAACD,KAHhEzE,EAAIwB,eAAe,CAACwC,GAAYvC,aAAa,CAAC+C,GAAG,CAACC,EAAcF,IACzD,IAnGH,IA+E2B3D,EAiBboD,EAAYS,EAAc7D,EAAK2D,EAhGzCI,EAAc,CACdd,QAASA,EACTO,OAAQA,EACR7B,OALSvC,EAAI4E,SAAS,CAAChE,EAM3B,EACA,GAAKZ,EAAIkD,YAAY,CAACtC,EAAK,uBAAwB+D,KAM/C,AAAiC,UAAjC,OAAQA,EAAYd,OAAO,EAC3Bc,CAAAA,EAAYd,OAAO,CAAGgB,KAAKC,SAAS,CAACH,EAAYd,OAAO,CAAA,EAG5D7D,EAAI+E,cAAc,CAACnE,EAAK,SAAUoE,CAAS,EACvCL,EAAYd,OAAO,CAAGmB,EAAUC,iBAAiB,CAACN,EAAYd,OAAO,CAAE,KAAMjD,EACjF,GAEI+D,AAAwB,OAAxBA,EAAYd,OAAO,EAAac,AAAwBzC,KAAAA,IAAxByC,EAAYd,OAAO,GAIvD,IAAIqB,EAAWlF,EAAImF,oBAAoB,CAACvE,GACxCZ,EAAIoF,IAAI,CAACT,EAAYpC,MAAM,CAAEoC,EAAYd,OAAO,CAAEqB,IACtD,EACJ,GACJ,EAxJuCxC,EACvB,GACAxB,EAAQP,EAA+B2B,EAAQnC,GAAc,SAAUuC,CAAK,GACxE2C,AAyDpB,SAAuBzE,CAAG,EAItB,GAAKZ,EAAI6C,YAAY,CAACjC,IAGtB,GAAI,CAACN,QAAS,OACVwC,SAAS,4GAIb,IAwF8BF,EAAQ0C,EAClCC,EAzFAvB,EAAa5C,EAA4BR,GAExCoD,IAsFyBpB,EAlFLoB,EAkFasB,EAlFD1E,EAmFjC2E,EAAWvF,EAAIwB,eAAe,CAAC8D,GAEnCE,AADmBxF,EAAIyF,eAAe,CAACH,GAC1BpE,OAAO,CAAC,SAAUwE,CAAE,EAC7B1F,EAAI2F,iBAAiB,CAACL,EAASI,EAAIH,EAAU,SAAU3E,CAAG,CAAEyB,CAAG,EAC3D,IAAIZ,EAAgBzB,EAAIwB,eAAe,CAACoB,GAAQnB,aAAa,CACzD2C,EAASpE,EAAIgD,iBAAiB,CAACsC,EAASnF,GACxCyF,EAAU5F,EAAI6F,UAAU,CAACP,EAAS1C,GAClCkD,EAAU9F,EAAI+F,cAAc,CAACT,EAAS,QACtCU,EAASF,EAAQE,MAAM,CACvBC,EAAgBC,OAAOC,MAAM,CAAC,CAAC,EAAGL,EAAQM,MAAM,EAChDC,EAAiBrG,EAAIsG,iBAAiB,CAAChB,GACvCiB,EAAgBvG,EAAIwG,YAAY,CAACP,EAAeI,GAChDI,EAAqBzG,EAAI0G,YAAY,CAACH,EAAejB,GAEzD,GADAmB,EAAmB,OAAU,CAAGb,EAC5BI,GAAUA,EAAOnE,MAAM,CAAG,EAAG,YAC7B7B,EAAIkD,YAAY,CAACoC,EAAS,yBAA0BU,GAInDhG,EAAIkD,YAAY,CAACoC,EAAS,0BAA2B,CAAElB,OAAQA,EAAQwB,QAASA,EAASW,cAAeA,EAAeE,mBAAoBA,CAAmB,KAInKhF,EAAckF,IAAI,CAACvC,EAAQqC,GACvBzG,EAAI4G,YAAY,CAACvE,EAAKiD,IACtBjD,EAAIwE,cAAc,GAGtB7G,EAAIkD,YAAY,CAACoC,EAAS,yBAA0B,CAAElB,OAAQA,EAAQP,QAAS4C,CAAmB,GAEtG,EACJ,IAjHJ,EA5EkC/D,EAClB,EACR,CACJ,CACJ,EAkSJ"}