@using AnimeFeedManager.Features.Tv.Library.Queries
@using AnimeFeedManager.Web.Features.Tv.Controls

@if (Series is not null)
{
    <SeriesCard SeriesInfo="@Series.TvSeries.AsSeriesCard()" LoaderId="@_loaderId" Id="@_cardId">
        <CardControls>
            @switch (Series)
            {
                case Available:
                case AvailableForSubscription:
                    <Badge Id="@_cardBadgeId" Text="Available" Type="StatusType.Success"></Badge>
                    break;
                case Subscribed:
                    <Badge Id="@_cardBadgeId" Text="Subscribed" Type="StatusType.Primary"></Badge>
                    break;
                case Interested:
                    <Badge Id="@_cardBadgeId" Text="Interested" Type="StatusType.Secondary"></Badge>
                    break;
                case Completed:
                    <Badge Id="@_cardBadgeId" Text="Completed" Type="StatusType.Info"></Badge>
                    break;
                default:
                    <Badge Id="@_cardBadgeId" Text="Not Available" Type="StatusType.Warning"></Badge>
                    break;
            }

            @if (Series.User is AuthenticatedUser)
            {
                <ExpandableFab>
                    <Buttons>
                        @switch (Series)
                        {
                            case AvailableForSubscription:
                                <ForSubscription Model="@GetSubscriptionModel(Series)"></ForSubscription>
                                break;
                            case Subscribed:
                                <ForSubscriptionRemoval Model="@GetSubscriptionModel(Series)"></ForSubscriptionRemoval>
                                break;
                            case AvailableForFuture:
                                <ForInterested Model="@GetInterestedModel(Series)"></ForInterested>
                                break;
                            case Interested:
                                <ForInterestedRemoval Model="@GetInterestedModel(Series)"></ForInterestedRemoval>
                                break;
                        }
                        
                        @if (Series.User is AdminUser)
                        {
                            <AlternativeTitlesEditorModal Model="GetAlternativeTitlesModel(Series)"></AlternativeTitlesEditorModal>
                            <SeriesDeleter Model="GetRemoveSeries(Series)"></SeriesDeleter>
                        }
                    </Buttons>
                </ExpandableFab>
            }

        </CardControls>
    </SeriesCard>
}

@code {
    [Parameter, EditorRequired] public UserTvSeries? Series { get; set; }
    private string _loaderId = string.Empty;
    private string _cardBadgeId = string.Empty;
    private string _loaderSelector = string.Empty;
    private string _cardId = string.Empty;

    protected override void OnInitialized()
    {
        _loaderId = IdHelpers.GetUniqueName("card-loader");
        _cardBadgeId = IdHelpers.GetUniqueName("card-badge");
        _cardId = IdHelpers.GetUniqueName("card");
        _loaderSelector = $"#{_loaderId}";
    }
    
    private TvInterestedViewModel GetInterestedModel(UserTvSeries series)
    {
        return new TvInterestedViewModel
        {
            SeriesTitle = series.TvSeries.Title,
            LoaderSelector = _loaderSelector,
            CardBadgeId = _cardBadgeId,
            SeriesId = series.TvSeries.Id,
        };
    }

    private TvSubscriptionViewModel GetSubscriptionModel(UserTvSeries series)
    {
        return new TvSubscriptionViewModel
        {
            SeriesTitle = series.TvSeries.Title,
            LoaderSelector = _loaderSelector,
            CardBadgeId = _cardBadgeId,
            SeriesId = series.TvSeries.Id,
            SeriesFeedTitle = series.TvSeries.FeedTitle ?? string.Empty,
            SeriesLink = series.TvSeries.FeedUrl ?? string.Empty
        };
    }

    private static AlternativeTitlesViewModel GetAlternativeTitlesModel(UserTvSeries series)
    {
        return new AlternativeTitlesViewModel
        {
            AlternativeTitles = series.TvSeries.AlternativeTitles,
            SeriesTitle = series.TvSeries.Title,
            Season = series.TvSeries.SeasonString,
            SeriesId = series.TvSeries.Id
        };
    }

    private RemoveSeriesViewModel GetRemoveSeries(UserTvSeries series)
    {
        return new RemoveSeriesViewModel
        {
            SeriesTitle = series.TvSeries.Title,
            Season = series.TvSeries.SeasonString,
            SeriesId = series.TvSeries.Id,
            LoaderSelector = _loaderSelector,
            CardId = _cardId
        };
    }
}