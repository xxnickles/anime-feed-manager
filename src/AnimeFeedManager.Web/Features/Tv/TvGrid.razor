@using System.Collections.Immutable
@using AnimeFeedManager.Features.Tv.Library.Queries
@using AnimeFeedManager.Features.Tv.Library.Storage.Stores
@using AnimeFeedManager.Features.Tv.Subscriptions.Storage.Stores
@using Azure.Storage.Blobs
@inject ITableClientFactory TableClientFactory
@inject BlobServiceClient BlobServiceClient;
@inject ILogger<TvGrid> Logger;
@inject IHttpContextAccessor HttpContextAccessor


<SeasonLinks SelectedSeason="Season"></SeasonLinks>
@if (_series.Count > 0)
{
    <SeriesGrid IsAuthenticated="@(_user is AuthenticatedUser)">
        @foreach (var series in _series)
        {
            <TvCard Series="series"></TvCard>
        }
    </SeriesGrid>
}
else
{
    <WarnBanner Title="Tv Series" Description="There are no series available for this season"></WarnBanner>
}


@code {
    [Parameter, EditorRequired] public SeriesSeason Season { get; set; } = new(Shared.Types.Season.Current, Year.Current);
    ImmutableList<UserTvSeries> _series = [];
    AppUser _user = new Anonymous();

    protected override async Task OnInitializedAsync()
    {
        _user = HttpContextAccessor.HttpContext?.GetCurrentUser() ?? new Anonymous();
        await TableClientFactory.TableStorageTvLibraryGetter
            .GetTvLibrarySeries(Season, BlobServiceClient.Uri, CancellationToken.None)
            .GetTvLibraryForUser(_user, TableClientFactory.TableStorageTvSubscriptions, CancellationToken.None)
            .WriteLogs(Logger)
            .Match(
                series => { _series = series; },
                _ => { _series = []; });
    }

}