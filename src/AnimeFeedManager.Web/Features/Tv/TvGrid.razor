@using System.Collections.Immutable
@using AnimeFeedManager.Features.Tv.Library.Queries
@using AnimeFeedManager.Features.Tv.Library.Storage
@using AnimeFeedManager.Features.Tv.Subscriptions.Storage
@using Azure.Storage.Blobs
@inject ITableClientFactory TableClientFactory
@inject BlobServiceClient BlobServiceClient;
@inject ILogger<TvGrid> Logger;
@inject IHttpContextAccessor HttpContextAccessor


<SeasonLinks SelectedSeason="Season"></SeasonLinks>
@if (_series.Count > 0)
{
    <SeriesGrid>
        @foreach (var series in _series)
        {
           <TvCard Series="series"></TvCard>
        }
    </SeriesGrid>
}
else
{
    <WarnBanner Title="Tv Series" Description="There are no series available for this season"></WarnBanner>
}


@code {
    [Parameter, EditorRequired] public SeriesSeason Season { get; set; } = new(Shared.Types.Season.Current, Year.Current);
    ImmutableList<UserTvSeries> _series = [];

    
    protected override async Task OnInitializedAsync()
    {
        var user = HttpContextAccessor.GetCurrentUser();
        await TableClientFactory.TableStorageTvLibraryGetter()
                                .GetTvLibrarySeries(Season, BlobServiceClient.Uri, CancellationToken.None)
                                .GetTvLibraryForUser(user, TableClientFactory.TableStorageTvSubscriptions(), CancellationToken.None)
                                .LogErrors(Logger)
                                .Match(
                                    series => { _series = series; },
                                    _ => { _series = []; });
    }

}