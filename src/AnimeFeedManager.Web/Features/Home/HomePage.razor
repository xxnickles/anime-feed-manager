@page "/"
@using AnimeFeedManager.Features.Seasons.Queries
@using AnimeFeedManager.Features.Seasons.Storage
@using AnimeFeedManager.Features.Seasons.UpdateProcess
@inject ITableClientFactory TableClientFactory;
@inject NavigationManager NavManager
@inject ILogger<HomePage> Logger;

<PageTitle>@PageTitle("Home")</PageTitle>

@if (!_seasonAvailable)
{
    <WarnBanner Title="No latest season!" Description="There is no latest season data available at this time"/>
}

@code {
    private bool _seasonAvailable = true;

    protected override async Task OnInitializedAsync()
    {
        await SeasonQueries.GetLatestSeason(TableClientFactory.TableStorageLatestSeason, CancellationToken.None)
            .FlushLogs(Logger)
            .Match(
                VerifyLatestSeason,
                _ => _seasonAvailable = false
            );
    }

    private void VerifyLatestSeason(SeasonStorageData seasonStorageData)
    {
        if (seasonStorageData is CurrentLatestSeason cls)
        {
            NavManager.NavigateTo($"{cls.Season.Season}-{cls.Season.Year}/tv");
        }
        else
        {
            _seasonAvailable = false;
        }
    }
}