@if (Model.Token is not null)
{
    <div id="add-credential-form"
         class="card-body"
         x-data="{
             status: 'loading',
             error: '',
             async register() {
                 try {
                     const p = new Passwordless.Client({ apiKey: API_KEY });
                     const { token: credential, error } = await p.register('@Model.Token');

                     if (credential) {
                         this.status = 'success';
                     } else {
                         this.error = error?.title || error?.message || 'Passkey registration failed';
                         this.status = 'error';
                     }
                 } catch (e) {
                     console.error('Passkey registration error:', e);
                     this.error = e.message || 'An unexpected error occurred';
                     this.status = 'error';
                 }
             }
         }"
         x-init="register()">

        <div x-show="status === 'loading'" class="flex flex-col items-center gap-4">
            <span class="loading loading-spinner loading-lg text-primary"></span>
            <p class="text-center">Setting up your passkey...</p>
        </div>

        <div x-show="status === 'success'" x-cloak class="flex flex-col items-center gap-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-success h-16 w-16" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p class="text-center text-lg font-semibold">Passkey added successfully!</p>
            <a class="btn btn-primary" href="/login">Login now</a>
        </div>

        <div x-show="status === 'error'" x-cloak class="flex flex-col items-center gap-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-error h-16 w-16" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p class="text-center text-error" x-text="error"></p>
            <button class="btn btn-outline" @click="location.reload()">Try again</button>
        </div>
    </div>
}
else
{
    <EditForm id="add-credential-form"
              Model="Model"
              hx-post="/add-credential"
              hx-swap="outerHTML"
              hx-indicator="#add-credential-loader"
              class="card-body">

        <input type="hidden" name="@nameof(Model.Id)" value="@Model.Id"/>

        <div class="text-center mb-4">
            <p class="text-sm text-base-content/70">Add a new passkey to your account</p>
        </div>

        <fieldset class="form-control mt-6">
            <button type="submit" class="btn btn-primary">
                Add Passkey
            </button>
            <span id="add-credential-loader" class="loading loading-spinner loading-sm htmx-indicator mt-2 mx-auto"></span>
        </fieldset>

        @if (HasError && Error is not null)
        {
            <div class="alert alert-error mt-4" role="alert">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none"
                     viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>@ErrorMessage</span>
            </div>
        }

        <div class="text-center mt-4">
            <a class="link link-primary text-sm font-semibold" href="/login">Skip and login</a>
        </div>
    </EditForm>
}

@code {
    [Parameter] public AddCredentialsViewModel Model { get; set; } = new();
    [Parameter] public DomainError? Error { get; set; }

    private bool HasError => Error is not null;

    private string ErrorMessage => Error switch
    {
        DomainValidationErrors validationErrors => string.Join(", ",
            validationErrors.Errors.SelectMany(e => e.Errors)),
        not null => Error.Message,
        _ => "Failed to add credential. Please try again."
    };

    public static RenderFragment AsRenderFragment(AddCredentialsViewModel model, DomainError? error = null) => builder =>
    {
        builder.OpenComponent<AddCredentialForm>(0);
        builder.AddAttribute(1, nameof(Model), model);
        builder.AddAttribute(2, nameof(Error), error);
        builder.CloseComponent();
    };

    public static RenderFragment ErrorFragment(AddCredentialsViewModel model, DomainError error) =>
        AsRenderFragment(model, error);

    public static RenderFragment SuccessFragment(AddCredentialsViewModel model) =>
        AsRenderFragment(model);
}
